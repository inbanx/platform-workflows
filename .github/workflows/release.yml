name: Release

on:
  workflow_call:
    inputs:
      npm-registry:
        description: npm registry server url
        required: true
      npm-scope:
        description: npm package scope
        required: true
    secrets:
      NPM_AUTH_TOKEN:
        description: "npm user auth token"
        required: true
      JIRA_BASE_URL:
        description: "The team JIRA Base URL"
        required: true
      JIRA_USER:
        description: "A JIRA user with permission to create a ticket"
        required: true
      JIRA_API_TOKEN:
        description: "An authentication token for the desired JIRA user with permission to create a ticket"
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v3
      - name: Configure git
        run: |
          git config --global user.email "${{ secrets.GIT_USER_EMAIL }}"
          git config --global user.name "${{ secrets.GIT_USER_NAME }}"

      - name: Configure publish scope
        uses: inbanx/platform-workflows/actions/registry@BNI-88
        with:
          npm-auth-token: ${{ secrets.NPM_AUTH_TOKEN }}
          npm-registry: ${{ inputs.npm-registry }}
          npm-scope: ${{ inputs.npm-scope }}

      - name: Get draft release version
        id: get_draft_release_version
        uses: inbanx/platform-workflows/actions/release-draft@BNI-88

      - name: Login
        uses: atlassian/gajira-login@master
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_TOKEN }}

      - name: Create Jira
        id: create
        uses: atlassian/gajira-create@master
        with:
          project: WEB
          issuetype: Task
          summary: |
            Release ${{ github.repository }} ${{ steps.get_draft_release_version.outputs.draft_release_version }}
          description: Release ${{ github.repository }} ${{ steps.get_draft_release_version.outputs.draft_release_version }}

      - name: Transition issue
        uses: atlassian/gajira-transition@master
        with:
          issue: ${{ steps.create.outputs.issue }}
          transition: "In progress"

      - name: Create release branch
        id: release_branch
        uses: inbanx/platform-workflows/actions/release-branch@BNI-88
        with:
          branch: automation-release-${{ steps.create.outputs.issue }}

      - name: Bump version and commit
        run: |
          npm version ${{ steps.get_draft_release_version.outputs.draft_release_version }} --no-git-tag-version
          git add .
          git commit -m '[${{ steps.create.outputs.issue }}] Release ${{ steps.get_draft_release_version.outputs.draft_release_version }}'

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.gh_token }}
          branch: ${{ steps.release_branch.outputs.release_branch }}

      - name: Create Pull Request
        id: create_pull_request
        uses: peter-evans/create-pull-request@v3
        with:
          branch: ${{ steps.release_branch.outputs.release_branch }}
          title: "[${{ steps.create.outputs.issue }}] Release ${{ steps.get_draft_release_version.outputs.draft_release_version }}"
          base: "main"
          body: |
            Bump release ${{ steps.get_draft_release_version.outputs.draft_release_version }}

      - name: Add label to PR
        uses: actions/github-script@v5
        with:
          github-token: ${{ secrets.gh_token }}
          script: |
            github.rest.issues.addLabels({
              issue_number: ${{ steps.create_pull_request.outputs.pull-request-number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['Patch']
            })

      - name: Approve PR
        uses: hmarr/auto-approve-action@v2
        with:
          github-token: ${{ secrets.gh_token }}
          pull-request-number: ${{ steps.create_pull_request.outputs.pull-request-number }}

      - name: Merge pull request
        uses: juliangruber/merge-pull-request-action@v1.1.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.create_pull_request.outputs.pull-request-number }}
          method: squash
